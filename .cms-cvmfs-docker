#!/bin/bash

cvmfs_docker() {
    local debug="false"
    local gitconfig="false"
    local mounts=""
    local name=""
    local persistence="--rm"
    local local=""
    local remote="/root/local_mount/"
    local ssh="false"
    local vnc=""
    local usage="$FUNCNAME [-h] [-m \"space separated mounts\"] [-l <local path to mount>] [-r <remote path to mount>]
    -- opens a temporary docker container for mounting CVMFS
       simply specify the mount points or "" for all and then specify an additional folder to mount into the container

    where:
        -d            print the command being used to invoke the docker container (default: ${debug})
        -g            mount the global gitconfig file from the host (default: ${gitconfig})
        -h            show this help text
        -l  [LOCAL]   local path to mount in container (default: ${local})
        -m  [MOUNTS]  sets the mount points; space separate multiple points inside quotes (default: ${mounts})
        -n  [NAME]    make the container persistent (default: ${name})
        -r  [REMOTE]  remote path to mount in the container (default: ${remote})
        -s            mount the .ssh folder (default: ${ssh})
        -v            expose the ports needed to use a VNC viewer (default: ${vnc})

    example: cvmfs_docker -m \"cms.cern.ch oasis.opensciencegrid.org\" -l `pwd` -r /root/workdir"

    local OPTIND OPTARG
    while getopts 'hdgm:n:l:r:sv' option; do
        case "$option" in
            d) debug="true"
               ;;
            g) gitconfig="true"
               ;;
            h) echo "$usage"
               return 0
               ;;
            l) local=$OPTARG
               ;;
            n) name=$OPTARG
               persistence=""
               ;;
            m) mounts=$OPTARG
               ;;
            r) remote=$OPTARG
               ;;
            s) ssh="true"
               ;;
            v) vnc="-p 5901:5901 -p 6080:6080"
               ;;
            :) printf "missing argument for -%s\n" "$OPTARG" >&2
               echo "$usage" >&2
               return -1
               ;;
            \?) printf "illegal option: -%s\n" "$OPTARG" >&2
                echo "$usage" >&2
                return -2
                ;;
        esac
    done
    shift $((OPTIND - 1))

    # Capture the output of the xhost command and look for the lines:
    #  "access control enabled, only authorized clients can connect"
    #  "INET:localhost
    # If the first is different, then the xhost access should be reset by doing:
    #  xhost -
    # Then check again. If either the second line is missing, or the first was there, but the second one was missing, then do:
    #  xhost +127.0.0.1
    # Then check again. If it's not right this time, then exit and throw an error
    xhost_enabled="access control enabled, only authorized clients can connect"
    xhost_localhost="INET:localhost"
    xhost_check="$(xhost)"
    if [[ $xhost_check == *"${xhost_localhost}"* ]]; then
        echo "Note::access control already enabled, including an opening for localhost"
    else
        xhost -
        xhost_check="$(xhost)"
        if [[ $xhost_check != *"${xhost_enabled}"* ]]; then
            xhost +127.0.0.1
            xhost_check="$(xhost)"
            if [[ $xhost_check != *"${xhost_localhost}"* ]]; then
                echo "ERROR:Unable to set the xhost settings properly"
                return -3
            fi
        fi
    fi


    if [[ "$local" != "" ]]; then
    local local_mount="-v ${local}:${remote}"
    else
    echo "NOTE: No local mount set."
    fi

    cmd="docker run ${persistence} -it -P ${vnc} --device /dev/fuse --cap-add SYS_ADMIN -e CVMFS_MOUNTS=\"${mounts}\" -e DISPLAY=host.docker.internal:0 -e MY_UID=$(id -u) -e MY_GID=$(id -g) -v ~/.globus:/home/cmsuser/.globus"
    if [[ "$ssh" == "true" ]]; then
        # ssh agent forwarding from:
        #  https://medium.com/@nazrulworld/ssh-agent-forward-into-docker-container-on-macos-ff847ec660e2
        #  https://docs.docker.com/docker-for-mac/osxfs/#ssh-agent-forwarding
        cmd="${cmd} -v ~/.ssh:/home/cmsuser/.ssh --mount type=bind,src=${SSH_AUTH_SOCK},target=${SSH_AUTH_SOCK} -e SSH_AUTH_SOCK=\"${SSH_AUTH_SOCK}\""
    fi
    if [[ "${gitconfig}" == "true" ]]; then
        cmd="${cmd} --mount type=bind,source=`readlink ${HOME}/.gitconfig`,target=/home/cmsuser/.gitconfig"
    fi
    if [[ -n $local_mount ]]; then
        cmd="${cmd} ${local_mount}"
    fi
    if [[ -n $name ]]; then
        cmd="${cmd} --name ${name}"
    fi
    cmd="${cmd} aperloff/cms-cvmfs-docker:latest"
    
    if [[ "$debug" == "true" ]]; then
        set -x
    fi
    eval ${cmd}
    set +x

    return 0
}
